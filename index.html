<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V2 Chess - 27 Lesson Academy</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%); min-height: 100vh; color: #fff; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ========================================
    // 27-LESSON NESTED THIRDS CHESS ACADEMY
    // PART 1: FRACTURE (Opening) - Lessons 1-9
    // PART 2: PRESSURE (Middlegame) - Lessons 10-18
    // PART 3: SHIFT (Endgame) - Lessons 19-27
    // ========================================

    const LESSONS = [
      // PART 1: FRACTURE (Opening) - "What's broken but not admitted"
      // Section 1: Seed - The Basics (1-3)
      { id: 1, part: 'FRACTURE', section: 'Seed', title: 'How Pieces Move',
        desc: 'Every piece has its own way of moving. The King moves 1 square any direction. The Queen moves any direction any distance. Rooks move straight. Bishops move diagonal. Knights jump in an L-shape. Pawns move forward but capture diagonal.',
        board: [['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']],
        highlight: [], task: 'Tap any piece to see how it moves!' },
      { id: 2, part: 'FRACTURE', section: 'Seed', title: 'Piece Values',
        desc: 'Not all pieces are equal! Pawn=1, Knight=3, Bishop=3, Rook=5, Queen=9, King=‚àû. Trading a Knight for a Rook is good (+2). Trading Queen for Bishop is bad (-6).',
        board: [[null,null,null,'q',null,null,null,null],[null,null,null,null,null,null,null,null],[null,'n',null,null,null,'b',null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,'R',null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],
        highlight: [[0,3],[2,1],[2,5],[5,2]], task: 'Queen=9, Knight=3, Bishop=3, Rook=5' },
      { id: 3, part: 'FRACTURE', section: 'Seed', title: 'The Goal: Checkmate',
        desc: 'Chess ends when the King is attacked and cannot escape. This is CHECKMATE. The King is in "check" when attacked. You must get out of check immediately!',
        board: [[null,null,null,null,'k',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'Q',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'K',null,null,'R']],
        highlight: [[0,4],[2,4]], task: 'Black King is in CHECK from the Queen!' },

      // Section 2: Develop - Opening Principles (4-6)
      { id: 4, part: 'FRACTURE', section: 'Develop', title: 'Control the Center',
        desc: 'The center squares (d4, d5, e4, e5) are the most important! Pieces in the center control more squares and can attack both sides of the board.',
        board: [['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']],
        highlight: [[3,3],[3,4],[4,3],[4,4]], task: 'The highlighted squares are the CENTER - control them!' },
      { id: 5, part: 'FRACTURE', section: 'Develop', title: 'Develop Your Pieces',
        desc: 'Get your Knights and Bishops out early! They\'re useless sitting on the back rank. Knights often go to f3/c3 (or f6/c6 for Black). Develop BEFORE attacking.',
        board: [['r',null,'b','q','k','b',null,'r'],['p','p','p','p','p','p','p','p'],[null,null,'n',null,null,'n',null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'P',null,null,null],[null,null,'N',null,null,'N',null,null],['P','P','P','P',null,'P','P','P'],['R',null,'B','Q','K','B',null,'R']],
        highlight: [[5,2],[5,5],[2,2],[2,5]], task: 'Both sides developed their Knights - good!' },
      { id: 6, part: 'FRACTURE', section: 'Develop', title: 'Castle for Safety',
        desc: 'Castling moves your King to safety AND activates your Rook! Castle early (usually kingside). Don\'t leave your King in the center where it can be attacked.',
        board: [['r',null,null,null,'k',null,null,'r'],['p','p','p',null,null,'p','p','p'],[null,null,'n','p',null,'n',null,null],[null,null,'b',null,'p',null,'b',null],[null,null,'B',null,'P',null,'B',null],[null,null,'N','P',null,'N',null,null],['P','P','P',null,null,'P','P','P'],['R',null,null,null,'K',null,null,'R']],
        highlight: [[7,4],[0,4]], task: 'Both Kings should castle soon!' },

      // Section 3: Turn - Common Mistakes (7-9)
      { id: 7, part: 'FRACTURE', section: 'Turn', title: 'Don\'t Move Same Piece Twice',
        desc: 'In the opening, develop a NEW piece each move. Moving the same piece twice wastes time (tempo) while your opponent develops more pieces.',
        board: [['r','n','b','q','k','b',null,'r'],['p','p','p','p','p','p','p','p'],[null,null,null,null,null,'n',null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,'N'],[null,null,null,null,null,null,null,null],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B',null,'R']],
        highlight: [[4,7]], task: 'White moved Knight twice - wasted a turn!' },
      { id: 8, part: 'FRACTURE', section: 'Turn', title: 'Don\'t Bring Queen Out Early',
        desc: 'The Queen is valuable! If you bring her out too early, she\'ll get chased by enemy pieces while they develop. Develop minor pieces first.',
        board: [['r','n','b',null,'k','b','n','r'],['p','p','p','p',null,'p','p','p'],[null,null,null,null,'p',null,null,null],[null,null,null,null,null,null,null,'q'],[null,null,'B',null,'P',null,null,null],[null,null,null,null,null,'N',null,null],['P','P','P','P',null,'P','P','P'],['R','N','B','Q','K',null,null,'R']],
        highlight: [[3,7]], task: 'Black\'s Queen came out early - will get attacked!' },
      { id: 9, part: 'FRACTURE', section: 'Turn', title: 'Protect Your Pieces',
        desc: 'Before making a move, ask: "Is my piece safe?" Look for enemy pieces attacking your undefended pieces. This is called a "hanging" piece.',
        board: [[null,null,null,null,'k',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,'B',null,null,null,null],[null,null,null,null,null,'p',null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'K',null,null,null]],
        highlight: [[3,3],[4,5]], task: 'White Bishop is HANGING - Black pawn can take it!' },

      // PART 2: PRESSURE (Middlegame) - "Can't ignore it anymore"
      // Section 1: Seed - Tactics Basics (10-12)
      { id: 10, part: 'PRESSURE', section: 'Seed', title: 'The Fork',
        desc: 'A FORK attacks two pieces at once! Knights are great at forking because they jump. If you fork a King and Queen, you win the Queen!',
        board: [[null,null,null,null,'k',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,'N',null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,'q',null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'K',null,null,null]],
        highlight: [[3,3],[0,4],[5,2]], task: 'Knight FORKS King and Queen! Queen is lost.' },
      { id: 11, part: 'PRESSURE', section: 'Seed', title: 'The Pin',
        desc: 'A PIN traps a piece because moving it would expose a more valuable piece behind it. An "absolute pin" is against the King - that piece CANNOT move!',
        board: [[null,null,null,null,'k',null,null,null],[null,null,null,null,'r',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'B',null,null,null],[null,null,null,null,'K',null,null,null]],
        highlight: [[6,4],[1,4],[0,4]], task: 'Rook is PINNED to King - it cannot move!' },
      { id: 12, part: 'PRESSURE', section: 'Seed', title: 'The Skewer',
        desc: 'A SKEWER is like a reverse pin - attack the valuable piece first, and when it moves, capture what\'s behind it!',
        board: [[null,null,null,null,null,null,null,null],[null,'k',null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,'B'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,'r']],
        highlight: [[4,7],[1,1],[7,7]], task: 'Bishop SKEWERS King - when King moves, Rook is taken!' },

      // Section 2: Develop - Advanced Tactics (13-15)
      { id: 13, part: 'PRESSURE', section: 'Develop', title: 'Discovered Attack',
        desc: 'Move one piece to REVEAL an attack by another piece behind it. Discovered checks are especially powerful!',
        board: [[null,null,null,null,'k',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'n',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'R',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'K',null,null,null]],
        highlight: [[2,4],[4,4],[0,4]], task: 'If Knight moves, Rook gives discovered CHECK!' },
      { id: 14, part: 'PRESSURE', section: 'Develop', title: 'Double Attack',
        desc: 'Attack two things at once - your opponent can only save one! Queens are great at double attacks because they move in all directions.',
        board: [[null,null,'r',null,'k',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'Q',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,'b'],[null,null,null,null,'K',null,null,null]],
        highlight: [[4,4],[0,4],[6,7]], task: 'Queen attacks BOTH King (check) and Bishop!' },
      { id: 15, part: 'PRESSURE', section: 'Develop', title: 'Remove the Defender',
        desc: 'If a piece is defended, capture the defender first! Then you can take the now-undefended piece.',
        board: [[null,null,null,null,'k',null,null,null],[null,null,null,null,'r',null,null,null],[null,null,null,null,'n',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'B',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'R',null,null,null],[null,null,null,null,'K',null,null,null]],
        highlight: [[2,4],[1,4],[4,4]], task: 'Bishop takes Knight, then Rook takes Rook!' },

      // Section 3: Turn - Positional Play (16-18)
      { id: 16, part: 'PRESSURE', section: 'Turn', title: 'Piece Activity',
        desc: 'Active pieces are powerful pieces! A Rook on an open file, a Bishop on a long diagonal, a Knight in the center - these control the game.',
        board: [[null,null,null,null,'k',null,null,'r'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,'B',null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['R',null,null,null,'K',null,null,null]],
        highlight: [[7,0],[3,1]], task: 'Rook on open file + Bishop on diagonal = ACTIVE!' },
      { id: 17, part: 'PRESSURE', section: 'Turn', title: 'Pawn Structure',
        desc: 'Pawns are the soul of chess! Doubled pawns (same file) are weak. Isolated pawns (no neighbors) need protection. Connected pawns support each other.',
        board: [[null,null,null,null,'k',null,null,null],['p',null,'p',null,null,'p','p','p'],[null,'p',null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['P',null,null,null,null,null,null,null],['P',null,'P','P',null,'P','P','P'],[null,null,null,null,'K',null,null,null]],
        highlight: [[5,0],[6,0],[1,2],[2,1]], task: 'White has doubled pawns (a-file). Black\'s b-pawn is isolated.' },
      { id: 18, part: 'PRESSURE', section: 'Turn', title: 'Weak Squares',
        desc: 'A weak square is one you can\'t defend with pawns. Knights love to occupy weak squares! Once there, they\'re very hard to kick out.',
        board: [[null,null,null,null,'k',null,null,null],[null,null,null,null,null,'p','p','p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,'N',null,null],[null,null,null,null,null,null,null,null],['P','P','P','P','P','P','P','P'],[null,null,null,null,'K',null,null,null]],
        highlight: [[4,5]], task: 'Knight on f4 - Black can\'t attack it with pawns!' },

      // PART 3: SHIFT (Endgame) - "Face what we've become"
      // Section 1: Seed - Basic Endgames (19-21)
      { id: 19, part: 'SHIFT', section: 'Seed', title: 'King + Queen vs King',
        desc: 'Use your Queen to push the enemy King to the edge. Your King helps trap it. Don\'t stalemate! Give checks that push, don\'t random checks.',
        board: [[null,null,null,null,null,null,null,null],[null,null,null,null,'k',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'Q',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'K',null,null,null]],
        highlight: [[5,4],[7,4],[1,4]], task: 'Push King to edge, use YOUR King to help trap!' },
      { id: 20, part: 'SHIFT', section: 'Seed', title: 'King + Rook vs King',
        desc: 'Same idea but slower. Use the Rook to cut off the King, push it to the edge. Your King must help! This takes practice.',
        board: [[null,null,null,null,null,null,null,null],[null,null,null,'k',null,null,null,null],[null,null,null,null,null,null,null,null],['R',null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,'K',null,null,null,null]],
        highlight: [[3,0],[7,3],[1,3]], task: 'Rook cuts off King. White King approaches.' },
      { id: 21, part: 'SHIFT', section: 'Seed', title: 'Pawn Promotion',
        desc: 'Getting a pawn to the last rank wins games! Your King must escort the pawn. The enemy King tries to stop it. Race to promote!',
        board: [[null,null,null,null,null,null,null,null],[null,null,null,'P',null,null,null,null],[null,null,null,'K',null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,'k',null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],
        highlight: [[1,3],[2,3]], task: 'King escorts pawn! Black King too far to stop it.' },

      // Section 2: Develop - Endgame Principles (22-24)
      { id: 22, part: 'SHIFT', section: 'Develop', title: 'Activate Your King',
        desc: 'In the endgame, your King becomes a FIGHTER! Bring him to the center to attack pawns and support your own. Don\'t keep him hiding!',
        board: [[null,null,null,null,null,null,null,null],['p',null,null,null,null,null,null,'p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'K',null,null,null],[null,null,null,null,null,null,null,null],['P',null,null,null,null,null,null,'P'],[null,null,null,null,null,null,null,'k']],
        highlight: [[4,4],[7,7]], task: 'White King active in center! Black King stuck in corner.' },
      { id: 23, part: 'SHIFT', section: 'Develop', title: 'Passed Pawns',
        desc: 'A PASSED pawn has no enemy pawns blocking or able to capture it. Passed pawns are powerful - they threaten to promote! Push them!',
        board: [[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,'P',null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,'p',null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,'K',null,null,'k',null]],
        highlight: [[2,3]], task: 'White\'s d-pawn is PASSED - nothing can stop it!' },
      { id: 24, part: 'SHIFT', section: 'Develop', title: 'Opposition',
        desc: 'When Kings face each other with one square between, whoever moves LOSES ground. This is "opposition" - crucial in King+Pawn endings!',
        board: [[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'k',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'K',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,'P',null,null,null],[null,null,null,null,null,null,null,null]],
        highlight: [[2,4],[4,4]], task: 'White HAS opposition - Black must move and give way!' },

      // Section 3: Turn - Mastery (25-27)
      { id: 25, part: 'SHIFT', section: 'Turn', title: 'Pattern Recognition',
        desc: 'Strong players see patterns instantly. Back rank mate, smothered mate, Greek gift sacrifice - learn these patterns and you\'ll spot them in your games!',
        board: [[null,null,null,null,null,null,'k',null],['p','p','p','p','p','p',null,'p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['R',null,null,null,null,null,'K',null]],
        highlight: [[7,0],[0,6]], task: 'BACK RANK MATE! Rook to a8 is checkmate!' },
      { id: 26, part: 'SHIFT', section: 'Turn', title: 'Calculation',
        desc: 'Calculate 2-3 moves ahead. For each candidate move, ask: What can opponent do? What do I do then? Visualize the board in your mind.',
        board: [[null,null,null,null,'k',null,null,'r'],[null,null,null,null,'p',null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,'N',null,null,null,null],[null,null,null,null,null,null,'q',null],[null,null,null,null,null,null,null,null],[null,null,null,null,'P',null,null,null],[null,null,null,null,'K',null,null,null]],
        highlight: [[3,3],[4,6]], task: 'Calculate: Nf6+, Kg7, Nxq! Think ahead!' },
      { id: 27, part: 'SHIFT', section: 'Turn', title: 'Putting It All Together',
        desc: 'You\'ve learned the journey: FRACTURE (opening flaws), PRESSURE (middlegame tactics), SHIFT (endgame transformation). Every game tells this story. Now go play!',
        board: [['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']],
        highlight: [], task: 'üéì You completed all 27 lessons! Now PLAY!' }
    ];

    // V2 Learning System
    const createLearning = () => ({
      versions: { A:{score:50,wins:0}, B:{score:50,wins:0}, C:{score:50,wins:0}, D:{score:50,wins:0}, E:{score:50,wins:0} },
      winningMoves: [], losingMoves: [], gamesPlayed: 0, gamesWon: 0, gamesLost: 0, learningRate: 1.0, lessonsCompleted: 0
    });

    const PIECE_VALUES = { p:100, n:320, b:330, r:500, q:900, k:20000 };
    const PAWN_TABLE = [0,0,0,0,0,0,0,0,50,50,50,50,50,50,50,50,10,10,20,30,30,20,10,10,5,5,10,25,25,10,5,5,0,0,0,20,20,0,0,0,5,-5,-10,0,0,-10,-5,5,5,10,10,-20,-20,10,10,5,0,0,0,0,0,0,0,0];
    const KNIGHT_TABLE = [-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,0,0,0,-20,-40,-30,0,10,15,15,10,0,-30,-30,5,15,20,20,15,5,-30,-30,0,15,20,20,15,0,-30,-30,5,10,15,15,10,5,-30,-40,-20,0,5,5,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50];

    const INIT_BOARD = [['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']];
    const SYMBOLS = { K:'‚ôî', Q:'‚ôï', R:'‚ôñ', B:'‚ôó', N:'‚ôò', P:'‚ôô', k:'‚ôö', q:'‚ôõ', r:'‚ôú', b:'‚ôù', n:'‚ôû', p:'‚ôü' };

    const HUMAN = 'white';
    const AI = 'black';

    function ChessV2() {
      const [board, setBoard] = useState(() => INIT_BOARD.map(r=>[...r]));
      const [turn, setTurn] = useState('white');
      const [selected, setSelected] = useState(null);
      const [validMoves, setValidMoves] = useState([]);
      const [mode, setMode] = useState('menu');
      const [status, setStatus] = useState('playing');
      const [learning, setLearning] = useState(createLearning);
      const [moves, setMoves] = useState([]);
      const [gameMoves, setGameMoves] = useState([]);
      const [thinking, setThinking] = useState(false);
      const [selfSpeed, setSelfSpeed] = useState(500);
      const [playing, setPlaying] = useState(false);
      const [currentLesson, setCurrentLesson] = useState(0);
      const [lessonBoard, setLessonBoard] = useState(null);

      const getMoves = useCallback((b,r,c,p) => {
        if(!p)return[];
        const moves=[];
        const isW=p===p.toUpperCase();
        const canGo=(row,col)=>{if(row<0||row>7||col<0||col>7)return false;const t=b[row][col];if(!t)return true;return isW?t===t.toLowerCase():t===t.toUpperCase();};
        const slide=(dr,dc)=>{for(let i=1;i<8;i++){const nr=r+dr*i,nc=c+dc*i;if(!canGo(nr,nc))break;moves.push([nr,nc]);if(b[nr]?.[nc])break;}};
        const type=p.toLowerCase();
        if(type==='p'){const dir=isW?-1:1;const start=isW?6:1;if(b[r+dir]?.[c]===null){moves.push([r+dir,c]);if(r===start&&b[r+2*dir]?.[c]===null)moves.push([r+2*dir,c]);}[-1,1].forEach(dc=>{const nr=r+dir,nc=c+dc;if(nr>=0&&nr<=7&&nc>=0&&nc<=7){const t=b[nr][nc];if(t&&(isW?t===t.toLowerCase():t===t.toUpperCase()))moves.push([nr,nc]);}});}
        else if(type==='n')[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>{if(canGo(r+dr,c+dc))moves.push([r+dr,c+dc]);});
        else if(type==='b')[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc])=>slide(dr,dc));
        else if(type==='r')[[1,0],[-1,0],[0,1],[0,-1]].forEach(([dr,dc])=>slide(dr,dc));
        else if(type==='q')[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc])=>slide(dr,dc));
        else if(type==='k')[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dr,dc])=>{if(canGo(r+dr,c+dc))moves.push([r+dr,c+dc]);});
        return moves;
      },[]);

      const getAllMoves = useCallback((b,player)=>{
        const all=[];const isW=player==='white';
        for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=b[r][c];if(p&&(isW?p===p.toUpperCase():p===p.toLowerCase()))getMoves(b,r,c,p).forEach(([tr,tc])=>all.push({from:[r,c],to:[tr,tc],piece:p}));}
        return all;
      },[getMoves]);

      const doMove = useCallback((b,from,to)=>{
        const nb=b.map(r=>[...r]);const[fr,fc]=from;const[tr,tc]=to;const p=nb[fr][fc];const cap=nb[tr][tc];
        if(p?.toLowerCase()==='p'&&(tr===0||tr===7))nb[tr][tc]=p==='P'?'Q':'q';else nb[tr][tc]=p;nb[fr][fc]=null;
        return{board:nb,captured:cap};
      },[]);

      const evaluate = useCallback((b,ver,learn)=>{
        let score=0;
        for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=b[r][c];if(!p)continue;const isW=p===p.toUpperCase();const val=PIECE_VALUES[p.toLowerCase()]||0;const sign=isW?1:-1;score+=sign*val;const type=p.toLowerCase();const tr=isW?r:7-r;const idx=tr*8+c;if(type==='p')score+=sign*PAWN_TABLE[idx];else if(type==='n')score+=sign*KNIGHT_TABLE[idx];if((r===3||r===4)&&(c===3||c===4))score+=sign*12;}
        const boost=1+learn.gamesPlayed*0.03;if(ver==='A')score*=0.9;else if(ver==='C')score*=1.1*boost;else if(ver==='D')score+=(Math.random()-0.5)*30;else if(ver==='E')score*=boost;
        return score;
      },[]);

      const minimax = useCallback((b,depth,alpha,beta,isMax,ver,learn)=>{
        if(depth===0)return evaluate(b,ver,learn);
        const player=isMax?'white':'black';const all=getAllMoves(b,player);if(all.length===0)return isMax?-50000:50000;
        if(isMax){let max=-Infinity;for(const m of all){const{board:nb}=doMove(b,m.from,m.to);max=Math.max(max,minimax(nb,depth-1,alpha,beta,false,ver,learn));alpha=Math.max(alpha,max);if(beta<=alpha)break;}return max;}
        else{let min=Infinity;for(const m of all){const{board:nb}=doMove(b,m.from,m.to);min=Math.min(min,minimax(nb,depth-1,alpha,beta,true,ver,learn));beta=Math.min(beta,min);if(beta<=alpha)break;}return min;}
      },[evaluate,getAllMoves,doMove]);

      const pickAIMove = useCallback((b,learn)=>{
        const all=getAllMoves(b,AI);if(all.length===0)return null;
        const depth=2+Math.min(2,Math.floor(learn.gamesPlayed/5));
        const versions=['A','B','C','D','E'];const votes={};
        versions.forEach(ver=>{let best=null,bestScore=Infinity;const shuffled=[...all].sort(()=>Math.random()-0.5);
          for(const m of shuffled){const{board:nb}=doMove(b,m.from,m.to);let score=minimax(nb,depth-1,-Infinity,Infinity,true,ver,learn);const key=`${m.piece}${m.from}${m.to}`;if(learn.winningMoves.includes(key))score-=20*learn.learningRate;if(learn.losingMoves.includes(key))score+=15*learn.learningRate;if(score<bestScore){bestScore=score;best=m;}}
          if(best){const key=`${best.from}-${best.to}`;if(!votes[key])votes[key]={move:best,count:0};const weight=1+learn.versions[ver].score/100;votes[key].count+=weight;}
        });
        let best=null,bestCount=-1;Object.values(votes).forEach(v=>{if(v.count>bestCount){bestCount=v.count;best=v.move;}});
        return best||all[0];
      },[getAllMoves,doMove,minimax]);

      const learnGame = useCallback((winner,gMoves)=>{
        setLearning(prev=>{const next={...prev};next.gamesPlayed++;next.learningRate=1+next.gamesPlayed*0.05;
          const aiKeys=gMoves.filter(m=>m.player===AI).map(m=>m.key);
          if(winner===AI){next.gamesWon++;next.winningMoves=[...next.winningMoves,...aiKeys].slice(-50);Object.keys(next.versions).forEach(v=>{next.versions[v].wins++;next.versions[v].score+=8;});}
          else if(winner===HUMAN){next.gamesLost++;next.losingMoves=[...next.losingMoves,...aiKeys].slice(-50);Object.keys(next.versions).forEach(v=>next.versions[v].score=Math.max(10,next.versions[v].score-4));}
          return next;});
      },[]);

      const aiMove = useCallback(()=>{
        if(status!=='playing')return;setThinking(true);
        setTimeout(()=>{const move=pickAIMove(board,learning);if(!move){setStatus('white-wins');learnGame(HUMAN,gameMoves);setThinking(false);return;}
          const{board:nb,captured}=doMove(board,move.from,move.to);const key=`${move.piece}${move.from}${move.to}`;
          if(captured?.toUpperCase()==='K'){setBoard(nb);setStatus('black-wins');learnGame(AI,[...gameMoves,{player:AI,key}]);setThinking(false);return;}
          setBoard(nb);setGameMoves(prev=>[...prev,{player:AI,key}]);setMoves(prev=>[...prev,{player:AI,piece:move.piece}]);setTurn(HUMAN);setThinking(false);
        },mode==='self-play'?100:400);
      },[board,status,mode,learning,pickAIMove,doMove,learnGame,gameMoves]);

      useEffect(()=>{if((mode==='play')&&turn===AI&&status==='playing'&&!thinking){const t=setTimeout(aiMove,300);return()=>clearTimeout(t);}},[turn,mode,status,thinking,aiMove]);

      const handleClick=(r,c)=>{
        if(mode==='lesson'){
          const p=lessonBoard?.[r]?.[c];
          if(p){setSelected([r,c]);setValidMoves(getMoves(lessonBoard,r,c,p));}else{setSelected(null);setValidMoves([]);}
          return;
        }
        if(status!=='playing'||thinking||mode==='self-play'||turn!==HUMAN)return;
        const p=board[r][c];const isOwn=p&&p===p.toUpperCase();
        if(selected){const[sr,sc]=selected;const isValid=validMoves.some(([vr,vc])=>vr===r&&vc===c);
          if(isValid){const movingPiece=board[sr][sc];const{board:nb,captured}=doMove(board,[sr,sc],[r,c]);const key=`${movingPiece}${sr},${sc}${r},${c}`;
            if(captured?.toLowerCase()==='k'){setBoard(nb);setStatus('white-wins');learnGame(HUMAN,[...gameMoves,{player:HUMAN,key}]);setSelected(null);setValidMoves([]);return;}
            setBoard(nb);setGameMoves(prev=>[...prev,{player:HUMAN,key}]);setMoves(prev=>[...prev,{player:HUMAN,piece:movingPiece}]);setSelected(null);setValidMoves([]);setTurn(AI);}
          else{setSelected(null);setValidMoves([]);if(isOwn){setSelected([r,c]);setValidMoves(getMoves(board,r,c,p));}}}
        else if(isOwn){setSelected([r,c]);setValidMoves(getMoves(board,r,c,p));}
      };

      useEffect(()=>{if(mode==='self-play'&&playing&&status==='playing'&&!thinking){
        const t=setTimeout(()=>{setThinking(true);const all=getAllMoves(board,turn);if(all.length===0){setStatus(turn==='white'?'black-wins':'white-wins');setLearning(prev=>({...prev,gamesPlayed:prev.gamesPlayed+1}));setThinking(false);return;}
          let move;if(turn===AI)move=pickAIMove(board,learning);else{let best=null,bestScore=-Infinity;for(const m of all){const{board:nb}=doMove(board,m.from,m.to);const score=evaluate(nb,'B',learning);if(score>bestScore){bestScore=score;best=m;}}move=best||all[0];}
          if(!move)move=all[0];const{board:nb,captured}=doMove(board,move.from,move.to);
          if(captured?.toLowerCase()==='k'||captured?.toUpperCase()==='K'){setBoard(nb);setStatus(turn==='white'?'white-wins':'black-wins');setLearning(prev=>({...prev,gamesPlayed:prev.gamesPlayed+1}));setThinking(false);return;}
          setBoard(nb);setMoves(prev=>[...prev,{player:turn,piece:move.piece}]);setTurn(turn==='white'?'black':'white');setThinking(false);
        },selfSpeed);return()=>clearTimeout(t);}},[mode,playing,status,thinking,turn,board,selfSpeed,getAllMoves,pickAIMove,doMove,evaluate,learning]);

      useEffect(()=>{if(mode==='self-play'&&playing&&status!=='playing'){const t=setTimeout(reset,1500);return()=>clearTimeout(t);}},[mode,playing,status]);

      const reset=useCallback(()=>{setBoard(INIT_BOARD.map(r=>[...r]));setTurn('white');setSelected(null);setValidMoves([]);setStatus('playing');setMoves([]);setGameMoves([]);setThinking(false);},[]);

      const startLesson=(idx)=>{setCurrentLesson(idx);setLessonBoard(LESSONS[idx].board.map(r=>[...r]));setSelected(null);setValidMoves([]);};

      const renderSquare=(r,c,isLesson=false)=>{
        const b=isLesson?lessonBoard:board;
        const p=b?.[r]?.[c];
        const light=(r+c)%2===0;
        const isSel=selected?.[0]===r&&selected?.[1]===c;
        const isTarget=validMoves.some(([vr,vc])=>vr===r&&vc===c);
        const lesson=isLesson?LESSONS[currentLesson]:null;
        const isHighlight=lesson?.highlight?.some(([hr,hc])=>hr===r&&hc===c);
        let bg=light?'#f0d9b5':'#b58863';
        if(isSel)bg='#ffd700';else if(isTarget)bg='#90EE90';else if(isHighlight)bg='#ff6b6b';
        return(<div key={`${r}-${c}`} onClick={()=>handleClick(r,c)} style={{width:40,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,background:bg,cursor:'pointer'}}>{p&&<span style={{color:p===p.toUpperCase()?'#fff':'#000',textShadow:p===p.toUpperCase()?'1px 1px 2px #000':'1px 1px 2px #fff'}}>{SYMBOLS[p]}</span>}{isTarget&&!p&&<div style={{width:10,height:10,borderRadius:'50%',background:'rgba(0,128,0,0.5)'}}/>}</div>);
      };

      // MENU
      if(mode==='menu'){
        return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:20}}>
          <div style={{fontSize:28,fontWeight:'bold',color:'#ffd700',marginBottom:8}}>‚ôî V2 Chess Academy ‚ôö</div>
          <div style={{fontSize:11,color:'#888',marginBottom:5}}>5-Version AI + 27 Nested Thirds Lessons</div>
          <div style={{fontSize:10,color:'#4ade80',marginBottom:15}}>You: WHITE ‚Ä¢ AI: BLACK</div>
          {learning.gamesPlayed>0&&<div style={{marginBottom:15,padding:8,background:'rgba(255,255,255,0.1)',borderRadius:6,textAlign:'center',fontSize:11}}><div style={{color:'#ffd700'}}>Games: {learning.gamesPlayed} | Lessons: {learning.lessonsCompleted}/27</div></div>}
          <div style={{display:'flex',flexDirection:'column',gap:10,width:'100%',maxWidth:280}}>
            <button onClick={()=>{setMode('play');reset();}} style={{padding:14,fontSize:14,fontWeight:'bold',background:'linear-gradient(135deg,#f093fb,#f5576c)',border:'none',borderRadius:8,color:'#fff',cursor:'pointer'}}>‚öîÔ∏è Challenge AI</button>
            <button onClick={()=>{setMode('lesson');startLesson(0);}} style={{padding:14,fontSize:14,fontWeight:'bold',background:'linear-gradient(135deg,#4ade80,#22c55e)',border:'none',borderRadius:8,color:'#fff',cursor:'pointer'}}>üìö Learn Chess (27 Lessons)</button>
            <button onClick={()=>{setMode('self-play');reset();}} style={{padding:14,fontSize:14,fontWeight:'bold',background:'linear-gradient(135deg,#667eea,#764ba2)',border:'none',borderRadius:8,color:'#fff',cursor:'pointer'}}>ü§ñ AI Self-Play</button>
          </div>
          <div style={{marginTop:20,padding:10,background:'rgba(255,255,255,0.05)',borderRadius:8,fontSize:9,color:'#666',textAlign:'center'}}>
            <div style={{color:'#ffd700',marginBottom:4}}>Nested Thirds Learning Path:</div>
            <span style={{color:'#ef4444'}}>FRACTURE</span> (1-9) ‚Üí <span style={{color:'#f59e0b'}}>PRESSURE</span> (10-18) ‚Üí <span style={{color:'#22c55e'}}>SHIFT</span> (19-27)
          </div>
        </div>);
      }

      // LESSON MODE
      if(mode==='lesson'){
        const lesson=LESSONS[currentLesson];
        const partColor=lesson.part==='FRACTURE'?'#ef4444':lesson.part==='PRESSURE'?'#f59e0b':'#22c55e';
        return(<div style={{minHeight:'100vh',padding:12}}>
          <div style={{display:'flex',flexDirection:'column',alignItems:'center'}}>
            <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10,width:'100%',maxWidth:400}}>
              <button onClick={()=>setMode('menu')} style={{padding:'5px 10px',background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.2)',borderRadius:5,color:'#fff',cursor:'pointer',fontSize:11}}>‚Üê Menu</button>
              <div style={{flex:1,textAlign:'center'}}><span style={{fontSize:12,fontWeight:'bold',color:'#ffd700'}}>Lesson {lesson.id}/27</span></div>
            </div>
            <div style={{marginBottom:8,textAlign:'center'}}>
              <span style={{fontSize:10,color:partColor,fontWeight:'bold'}}>{lesson.part}</span>
              <span style={{fontSize:10,color:'#666'}}> ‚Ä¢ {lesson.section}</span>
            </div>
            <div style={{fontSize:14,fontWeight:'bold',color:'#fff',marginBottom:8,textAlign:'center'}}>{lesson.title}</div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(8,40px)',border:'2px solid #444',borderRadius:3,marginBottom:12}}>
              {[...Array(8)].map((_,r)=>[...Array(8)].map((_,c)=>renderSquare(r,c,true)))}
            </div>
            <div style={{maxWidth:350,padding:12,background:'rgba(255,255,255,0.05)',borderRadius:8,marginBottom:10}}>
              <div style={{fontSize:11,color:'#ccc',lineHeight:1.5,marginBottom:8}}>{lesson.desc}</div>
              <div style={{fontSize:10,color:'#4ade80',fontStyle:'italic'}}>üéØ {lesson.task}</div>
            </div>
            <div style={{display:'flex',gap:8,marginBottom:10}}>
              <button onClick={()=>{if(currentLesson>0)startLesson(currentLesson-1);}} disabled={currentLesson===0} style={{padding:'8px 16px',background:currentLesson===0?'#333':'#3b82f6',border:'none',borderRadius:5,color:'#fff',cursor:currentLesson===0?'default':'pointer',fontSize:12}}>‚Üê Prev</button>
              <button onClick={()=>{if(currentLesson<26){startLesson(currentLesson+1);setLearning(prev=>({...prev,lessonsCompleted:Math.max(prev.lessonsCompleted,currentLesson+1)}));}else{setMode('menu');setLearning(prev=>({...prev,lessonsCompleted:27}));}}} style={{padding:'8px 16px',background:'#22c55e',border:'none',borderRadius:5,color:'#fff',cursor:'pointer',fontSize:12}}>{currentLesson===26?'üéì Complete!':'Next ‚Üí'}</button>
            </div>
            <div style={{display:'flex',gap:4,flexWrap:'wrap',justifyContent:'center',maxWidth:350}}>
              {LESSONS.map((l,i)=>(<div key={i} onClick={()=>startLesson(i)} style={{width:20,height:20,borderRadius:3,display:'flex',alignItems:'center',justifyContent:'center',fontSize:8,cursor:'pointer',background:i===currentLesson?'#ffd700':i<learning.lessonsCompleted?'#22c55e':'rgba(255,255,255,0.1)',color:i===currentLesson?'#000':'#fff'}}>{i+1}</div>))}
            </div>
          </div>
        </div>);
      }

      // GAME SCREEN
      return(<div style={{minHeight:'100vh',padding:12}}>
        <div style={{display:'flex',flexDirection:'column',alignItems:'center'}}>
          <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:10}}>
            <button onClick={()=>{setMode('menu');setPlaying(false);}} style={{padding:'6px 12px',background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.2)',borderRadius:5,color:'#fff',cursor:'pointer',fontSize:12}}>‚Üê Menu</button>
            <span style={{fontSize:14,fontWeight:'bold',color:'#ffd700'}}>{mode==='self-play'?'ü§ñ Self-Play':'‚öîÔ∏è vs AI'}</span>
          </div>
          <div style={{fontSize:10,color:'#ef4444',marginBottom:4}}>‚¨ÜÔ∏è AI (Black) ‚Ä¢ {learning.gamesPlayed} games</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(8,44px)',border:'2px solid #444',borderRadius:3}}>
            {[...Array(8)].map((_,r)=>[...Array(8)].map((_,c)=>renderSquare(r,c)))}
          </div>
          <div style={{fontSize:10,color:'#4ade80',marginTop:4}}>‚¨áÔ∏è YOU (White)</div>
          <div style={{marginTop:12,padding:'10px 20px',borderRadius:6,fontWeight:'bold',fontSize:13,background:status==='white-wins'?'#22c55e':status==='black-wins'?'#ef4444':thinking?'#f59e0b':'#4ade80',color:'#000'}}>
            {status==='white-wins'?'üéâ You Win!':status==='black-wins'?'ü§ñ AI Wins!':thinking?'ü§î AI Thinking...':'üëÜ Your Turn!'}
          </div>
          {mode==='self-play'&&<div style={{marginTop:12,display:'flex',gap:8}}>
            <button onClick={()=>setPlaying(!playing)} style={{padding:'8px 16px',border:'none',borderRadius:5,color:'#fff',cursor:'pointer',background:playing?'#ef4444':'#22c55e',fontWeight:'bold',fontSize:12}}>{playing?'‚è∏ Pause':'‚ñ∂ Play'}</button>
            <select value={selfSpeed} onChange={e=>setSelfSpeed(Number(e.target.value))} style={{padding:8,background:'#333',border:'1px solid #555',borderRadius:5,color:'#fff',fontSize:12}}><option value={800}>Slow</option><option value={500}>Normal</option><option value={200}>Fast</option></select>
          </div>}
          {mode==='play'&&<button onClick={reset} style={{marginTop:12,padding:'8px 16px',background:'#3b82f6',border:'none',borderRadius:5,color:'#fff',cursor:'pointer',fontSize:12}}>üîÑ New Game</button>}
          <div style={{marginTop:12,display:'flex',gap:6}}>
            {Object.entries(learning.versions).map(([v,d])=>(<div key={v} style={{padding:'3px 6px',background:'rgba(255,255,255,0.05)',borderRadius:4,fontSize:9}}><span style={{color:v==='A'?'#3b82f6':v==='B'?'#22c55e':v==='C'?'#ef4444':v==='D'?'#a855f7':'#f59e0b',fontWeight:'bold'}}>{v}</span><span style={{color:'#666',marginLeft:3}}>{d.score}</span></div>))}
          </div>
          <div style={{marginTop:8,fontSize:10,color:'#555'}}>Moves: {moves.length} ‚Ä¢ Depth: {2+Math.min(2,Math.floor(learning.gamesPlayed/5))}</div>
        </div>
      </div>);
    }

    ReactDOM.render(<ChessV2/>,document.getElementById('root'));
  </script>
</body>
</html>
