P<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V2 Chess Academy - Complete Learning Platform</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%);
      min-height: 100vh;
      color: #fff;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    button { font-family: inherit; }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    select { font-family: inherit; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // Configuration
    const GUMROAD_LINK = "https://popcornwhisper.gumroad.com/l/V2ChessAcademy";
    const UNLOCK_CODE = "V2CHESS2024";

    // Chess piece values
    const PIECE_VALUES = {
      'p': 100, 'n': 320, 'b': 330, 'r': 500, 'q': 900, 'k': 20000,
      'P': 100, 'N': 320, 'B': 330, 'R': 500, 'Q': 900, 'K': 20000
    };

    // Position tables
    const PAWN_TABLE = [
      0,0,0,0,0,0,0,0, 50,50,50,50,50,50,50,50, 10,10,20,30,30,20,10,10,
      5,5,10,25,25,10,5,5, 0,0,0,20,20,0,0,0, 5,-5,-10,0,0,-10,-5,5,
      5,10,10,-20,-20,10,10,5, 0,0,0,0,0,0,0,0
    ];

    const KNIGHT_TABLE = [
      -50,-40,-30,-30,-30,-30,-40,-50, -40,-20,0,0,0,0,-20,-40, -30,0,10,15,15,10,0,-30,
      -30,5,15,20,20,15,5,-30, -30,0,15,20,20,15,0,-30, -30,5,10,15,15,10,5,-30,
      -40,-20,0,5,5,0,-20,-40, -50,-40,-30,-30,-30,-30,-40,-50
    ];

    const BISHOP_TABLE = [
      -20,-10,-10,-10,-10,-10,-10,-20, -10,0,0,0,0,0,0,-10, -10,0,5,10,10,5,0,-10,
      -10,5,5,10,10,5,5,-10, -10,0,10,10,10,10,0,-10, -10,10,10,10,10,10,10,-10,
      -10,5,0,0,0,0,5,-10, -20,-10,-10,-10,-10,-10,-10,-20
    ];

    const KING_TABLE = [
      -30,-40,-40,-50,-50,-40,-40,-30, -30,-40,-40,-50,-50,-40,-40,-30,
      -30,-40,-40,-50,-50,-40,-40,-30, -30,-40,-40,-50,-50,-40,-40,-30,
      -20,-30,-30,-40,-40,-30,-30,-20, -10,-20,-20,-20,-20,-20,-20,-10,
      20,20,0,0,0,0,20,20, 20,30,10,0,0,10,30,20
    ];

    const INITIAL_BOARD = [
      ['r','n','b','q','k','b','n','r'],
      ['p','p','p','p','p','p','p','p'],
      [null,null,null,null,null,null,null,null],
      [null,null,null,null,null,null,null,null],
      [null,null,null,null,null,null,null,null],
      [null,null,null,null,null,null,null,null],
      ['P','P','P','P','P','P','P','P'],
      ['R','N','B','Q','K','B','N','R']
    ];

    const PIECE_SYMBOLS = {
      'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô',
      'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü'
    };

    const PIECE_NAMES = {
      'K': 'King', 'Q': 'Queen', 'R': 'Rook', 'B': 'Bishop', 'N': 'Knight', 'P': 'Pawn',
      'k': 'King', 'q': 'Queen', 'r': 'Rook', 'b': 'Bishop', 'n': 'Knight', 'p': 'Pawn'
    };

    const LESSONS = [
      { id: 1, title: "How Pieces Move", part: 1, section: 1, beat: 1, content: "Each piece moves differently. Pawns forward, Knights L-shape, Bishops diagonal..." },
      { id: 2, title: "Piece Values", part: 1, section: 1, beat: 2, content: "Pawn=1, Knight=3, Bishop=3, Rook=5, Queen=9. King is priceless!" },
      { id: 3, title: "The Goal: Checkmate", part: 1, section: 1, beat: 3, content: "Checkmate = King is attacked and has no escape. That's how you win!" },
      { id: 4, title: "Control the Center", part: 1, section: 2, beat: 1, content: "d4, d5, e4, e5 are the most important squares. Control them early!" },
      { id: 5, title: "Develop Your Pieces", part: 1, section: 2, beat: 2, content: "Move Knights and Bishops before the Queen. Get all pieces ready for battle!" },
      { id: 6, title: "Castle for Safety", part: 1, section: 2, beat: 3, content: "Castling moves King to safety and activates Rook. Do this early!" },
      { id: 7, title: "Don't Move Twice", part: 1, section: 3, beat: 1, content: "In the opening, each piece should move once before you move any twice. Variety!" },
      { id: 8, title: "Queen Out Too Early?", part: 1, section: 3, beat: 2, content: "Your Queen is powerful but vulnerable. Keep her safe behind pawns!" },
      { id: 9, title: "Protect Your Pieces", part: 1, section: 3, beat: 3, content: "Don't leave pieces undefended. Every attack needs a counter!" },
      { id: 10, title: "The Fork", part: 2, section: 1, beat: 1, content: "Attacking two pieces at once. Knight forks are deadly!" },
      { id: 11, title: "The Pin", part: 2, section: 1, beat: 2, content: "Bishop or Rook attacks through a piece to a more valuable piece behind it." },
      { id: 12, title: "The Skewer", part: 2, section: 1, beat: 3, content: "Like a pin but reversed - valuable piece first, then piece behind." },
      { id: 13, title: "Discovered Attack", part: 2, section: 2, beat: 1, content: "Move one piece to unleash attack from piece behind it!" },
      { id: 14, title: "Double Attack", part: 2, section: 2, beat: 2, content: "Attack multiple pieces or create multiple threats simultaneously." },
      { id: 15, title: "Remove the Defender", part: 2, section: 2, beat: 3, content: "Capture or deflect the piece protecting another piece." },
      { id: 16, title: "Piece Activity", part: 2, section: 3, beat: 1, content: "Active pieces control more squares and create more threats." },
      { id: 17, title: "Pawn Structure", part: 2, section: 3, beat: 2, content: "Pawn chains are strong. Weak pawns become targets!" },
      { id: 18, title: "Weak Squares", part: 2, section: 3, beat: 3, content: "Squares your pawns can't protect. Plant pieces there!" },
      { id: 19, title: "Basic Checkmates", part: 3, section: 1, beat: 1, content: "Queen + King vs King. Rook + King vs King. Know these!" },
      { id: 20, title: "Pawn Promotion", part: 3, section: 1, beat: 2, content: "When pawn reaches the end, promote to Queen (usually). Extremely powerful!" },
      { id: 21, title: "Opposition", part: 3, section: 1, beat: 3, content: "Kings directly opposite with one square between = you control the position." },
      { id: 22, title: "King Activation", part: 3, section: 2, beat: 1, content: "In endgame, King is strong! Bring it into the action to support pawns." },
      { id: 23, title: "Passed Pawns", part: 3, section: 2, beat: 2, content: "Pawn with no enemy pawns ahead. Try to promote it!" },
      { id: 24, title: "Zugzwang", part: 3, section: 2, beat: 3, content: "Opponent has no good moves. Any move makes position worse. You win!" },
      { id: 25, title: "Calculate Variations", part: 3, section: 3, beat: 1, content: "See 3-4 moves ahead. Predict opponent's responses." },
      { id: 26, title: "Pattern Recognition", part: 3, section: 3, beat: 2, content: "Recognize mating patterns, sacrifice patterns, endgame patterns." },
      { id: 27, title: "Mastery: Play Stronger", part: 3, section: 3, beat: 3, content: "Bring it all together. Play, analyze, improve. You are a chess player!" }
    ];

    const PUZZLES = [
      { id: 1, title: "Fork the King", difficulty: 1, description: "Knight fork wins material" },
      { id: 2, title: "Pin the Bishop", difficulty: 1, description: "Pin captures Bishop" },
      { id: 3, title: "Mate in One", difficulty: 2, description: "Find the checkmate!" },
      { id: 4, title: "Discovered Attack", difficulty: 2, description: "Unleash hidden piece" },
      { id: 5, title: "Sacrifice for Mate", difficulty: 3, description: "Give up material to checkmate" },
      { id: 6, title: "Quiet Move Wins", difficulty: 2, description: "Hidden winning move" },
      { id: 7, title: "Back Rank Mate", difficulty: 2, description: "Trap the King!" },
      { id: 8, title: "Deflection Tactic", difficulty: 3, description: "Remove the defender" },
      { id: 9, title: "Stalemate Trap", difficulty: 3, description: "Force a draw" },
      { id: 10, title: "Perpetual Check", difficulty: 3, description: "Eternal checks = draw" }
    ];

    const OPENINGS = [
      { name: "Italian Game", moves: "1.e4 e5 2.Nf3 Nc6 3.Bc4", ideas: "Control center, develop, attack f7" },
      { name: "Sicilian Defense", moves: "1.e4 c5", ideas: "Black fights for center, popular!" },
      { name: "French Defense", moves: "1.e4 e6", ideas: "Solid structure, c4 pawn break" },
      { name: "Caro-Kann Defense", moves: "1.e4 c6", ideas: "Rock solid, d5 breakout" },
      { name: "Ruy Lopez (Spanish)", moves: "1.e4 e5 2.Nf3 Nc6 3.Bb5", ideas: "Most popular! Control e5" },
      { name: "Queen's Gambit", moves: "1.d4 d5 2.c4", ideas: "Sacrifice pawn for space" },
      { name: "King's Indian", moves: "1.d4 Nf6 2.c4 g6", ideas: "Fianchetto, counterattack" },
      { name: "London System", moves: "1.d4 2.Bf4 3.Nf3 4.e3", ideas: "Flexible, solid structure" },
      { name: "Scotch Game", moves: "1.e4 e5 2.Nf3 Nc6 3.Nxe5", ideas: "Open game, tactical" },
      { name: "Nimzo-Indian", moves: "1.d4 Nf6 2.c4 e6 3.Nc3 Bb4", ideas: "Counter-pin, flexible" },
      { name: "Slav Defense", moves: "1.d4 d5 2.c4 c6", ideas: "Solid, fighting for d5" },
      { name: "Grunfeld Defense", moves: "1.d4 Nf6 2.c4 g6 3.Nc3 d5", ideas: "Counterattack center" },
      { name: "English Opening", moves: "1.c4", ideas: "Flexible, positional control" },
      { name: "Alekhine's Defense", moves: "1.e4 Nf6", ideas: "Provoke pawns, counterattack" },
      { name: "Bird's Opening", moves: "1.f4", ideas: "Control e5, fianchetto idea" }
    ];

    const VIDEOS = [
      { title: "How to Play Chess (Beginners)", creator: "GothamChess", url: "https://youtube.com/results?search_query=gothamchess+how+to+play+chess" },
      { title: "Chess Opening Principles", creator: "Daniel Naroditsky", url: "https://youtube.com/results?search_query=daniel+naroditsky+chess+openings" },
      { title: "Tactics Training", creator: "GothamChess", url: "https://youtube.com/results?search_query=gothamchess+tactics+training" },
      { title: "Endgame Basics", creator: "Agadmator", url: "https://youtube.com/results?search_query=agadmator+endgame+basics" },
      { title: "Middle Game Strategy", creator: "GothamChess", url: "https://youtube.com/results?search_query=gothamchess+middlegame+strategy" },
      { title: "Checkmate Patterns", creator: "GothamChess", url: "https://youtube.com/results?search_query=gothamchess+checkmate+patterns" },
      { title: "Positional Chess", creator: "Agadmator", url: "https://youtube.com/results?search_query=agadmator+positional+chess" },
      { title: "Chess Sacrifice", creator: "GothamChess", url: "https://youtube.com/results?search_query=gothamchess+sacrifice" },
      { title: "Pawn Structures", creator: "Daniel Naroditsky", url: "https://youtube.com/results?search_query=naroditsky+pawn+structures" },
      { title: "King Activity in Endgame", creator: "Agadmator", url: "https://youtube.com/results?search_query=agadmator+king+endgame" },
      { title: "Pin and Fork Tactics", creator: "GothamChess", url: "https://youtube.com/results?search_query=gothamchess+pin+fork" },
      { title: "Chess for Beginners", creator: "Lichess", url: "https://youtube.com/results?search_query=lichess+chess+for+beginners" }
    ];

    const createLearningSystem = () => ({
      versionPerformance: {
        A: { wins: 0, losses: 0, draws: 0, score: 50 },
        B: { wins: 0, losses: 0, draws: 0, score: 50 },
        C: { wins: 0, losses: 0, draws: 0, score: 50 },
        D: { wins: 0, losses: 0, draws: 0, score: 50 },
        E: { wins: 0, losses: 0, draws: 0, score: 50 }
      },
      humanPatterns: {},
      winningSequences: [],
      losingSequences: [],
      positionMemory: {},
      humanWeaknesses: {},
      gamesPlayed: 0,
      gamesWonVsHuman: 0,
      gamesLostVsHuman: 0,
      learningRate: 1.0,
      difficultyLevel: 1,
      unlockedFeatures: false,
      unlockedCode: ""
    });

    function ChessV2Academy() {
      const [board, setBoard] = useState(INITIAL_BOARD.map(row => [...row]));
      const [currentPlayer, setCurrentPlayer] = useState('white');
      const [selectedSquare, setSelectedSquare] = useState(null);
      const [validMoves, setValidMoves] = useState([]);
      const [gameMode, setGameMode] = useState('menu');
      const [gameStatus, setGameStatus] = useState('active');
      const [learningData, setLearningData] = useState(createLearningSystem);
      const [moveLog, setMoveLog] = useState([]);
      const [positionHistory, setPositionHistory] = useState([]);
      const [lastFourMoves, setLastFourMoves] = useState([]);
      const [stuckCounter, setStuckCounter] = useState(0);
      const [currentGameMoves, setCurrentGameMoves] = useState([]);
      const [showUnlockModal, setShowUnlockModal] = useState(false);
      const [unlockInput, setUnlockInput] = useState("");
      const [aiThinking, setAiThinking] = useState('');
      const [puzzleMode, setPuzzleMode] = useState('select');
      const [currentPuzzle, setCurrentPuzzle] = useState(null);
      const [puzzleRating, setPuzzleRating] = useState(800);
      const [currentLesson, setCurrentLesson] = useState(null);
      const [twoPlayerMode, setTwoPlayerMode] = useState(false);
      const [selfPlaySpeed, setSelfPlaySpeed] = useState(400);
      const [isPlaying, setIsPlaying] = useState(false);
      const [gameCount, setGameCount] = useState(0);

      const selfPlayRef = useRef(null);

      const boardToString = useCallback((b) => {
        return b.map(row => row.map(p => p || '.').join('')).join('/');
      }, []);

      const isPlayerPiece = useCallback((piece, player) => {
        if (!piece) return false;
        return player === 'white' ? piece === piece.toUpperCase() : piece === piece.toLowerCase();
      }, []);

      const getValidMoves = useCallback((board, row, col, piece) => {
        const moves = [];
        if (!piece) return moves;
        const isWhite = piece === piece.toUpperCase();

        const addMoveIfValid = (r, c) => {
          if (r >= 0 && r < 8 && c >= 0 && c < 8) {
            const target = board[r][c];
            if (!target || (isWhite ? target === target.toLowerCase() : target === target.toUpperCase())) {
              moves.push([r, c]);
              return !target;
            }
          }
          return false;
        };

        const pieceType = piece.toLowerCase();

        switch (pieceType) {
          case 'p': {
            const dir = isWhite ? -1 : 1;
            const startRow = isWhite ? 6 : 1;
            if (board[row + dir]?.[col] === null) {
              moves.push([row + dir, col]);
              if (row === startRow && board[row + 2 * dir]?.[col] === null) {
                moves.push([row + 2 * dir, col]);
              }
            }
            [-1, 1].forEach(dc => {
              const target = board[row + dir]?.[col + dc];
              if (target && (isWhite ? target === target.toLowerCase() : target === target.toUpperCase())) {
                moves.push([row + dir, col + dc]);
              }
            });
            break;
          }
          case 'n':
            [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr, dc]) => {
              addMoveIfValid(row + dr, col + dc);
            });
            break;
          case 'b':
            [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr, dc]) => {
              for (let i = 1; i < 8; i++) if (!addMoveIfValid(row + dr*i, col + dc*i)) break;
            });
            break;
          case 'r':
            [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dr, dc]) => {
              for (let i = 1; i < 8; i++) if (!addMoveIfValid(row + dr*i, col + dc*i)) break;
            });
            break;
          case 'q':
            [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr, dc]) => {
              for (let i = 1; i < 8; i++) if (!addMoveIfValid(row + dr*i, col + dc*i)) break;
            });
            break;
          case 'k':
            [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dr, dc]) => {
              addMoveIfValid(row + dr, col + dc);
            });
            break;
          default: break;
        }
        return moves;
      }, []);

      const getAllMoves = useCallback((board, player) => {
        const moves = [];
        for (let r = 0; r < 8; r++) {
          for (let c = 0; c < 8; c++) {
            const piece = board[r][c];
            if (piece && isPlayerPiece(piece, player)) {
              getValidMoves(board, r, c, piece).forEach(([toR, toC]) => {
                moves.push({ from: [r, c], to: [toR, toC], piece });
              });
            }
          }
        }
        return moves;
      }, [getValidMoves, isPlayerPiece]);

      const applyMove = useCallback((board, from, to) => {
        const newBoard = board.map(row => [...row]);
        const [fromR, fromC] = from;
        const [toR, toC] = to;
        const piece = newBoard[fromR][fromC];

        if (piece?.toLowerCase() === 'p' && (toR === 0 || toR === 7)) {
          newBoard[toR][toC] = piece === 'P' ? 'Q' : 'q';
        } else {
          newBoard[toR][toC] = piece;
        }
        newBoard[fromR][fromC] = null;
        return newBoard;
      }, []);

      const evaluatePosition = useCallback((board, version, depth = 0, learning) => {
        let score = 0;
        let whiteMaterial = 0, blackMaterial = 0;
        let centerControl = 0, development = 0;

        for (let r = 0; r < 8; r++) {
          for (let c = 0; c < 8; c++) {
            const piece = board[r][c];
            if (!piece) continue;

            const isWhite = piece === piece.toUpperCase();
            const value = PIECE_VALUES[piece] || 0;
            const sign = isWhite ? 1 : -1;

            if (isWhite) whiteMaterial += value; else blackMaterial += value;

            const pieceType = piece.toLowerCase();
            const tableRow = isWhite ? r : 7 - r;
            const idx = tableRow * 8 + c;

            if (pieceType === 'p') score += sign * PAWN_TABLE[idx];
            else if (pieceType === 'n') score += sign * KNIGHT_TABLE[idx];
            else if (pieceType === 'b') score += sign * BISHOP_TABLE[idx];
            else if (pieceType === 'k') score += sign * KING_TABLE[idx];

            if ((r === 3 || r === 4) && (c === 3 || c === 4)) centerControl += sign * 15;
            if ((pieceType === 'n' || pieceType === 'b') && r !== (isWhite ? 7 : 0)) development += sign * 20;
          }
        }

        score += whiteMaterial - blackMaterial;

        const posStr = boardToString(board);
        if (learning.positionMemory[posStr]) {
          score += learning.positionMemory[posStr] * learning.learningRate * 50;
        }

        const learningBoost = 1 + (learning.gamesPlayed * 0.05);

        switch (version) {
          case 'A':
            score += centerControl * 0.5 * learningBoost;
            score += development * 0.8;
            break;
          case 'B':
            score += centerControl * 1.0 * learningBoost;
            score += development * 1.0 * learningBoost;
            break;
          case 'C':
            score += centerControl * 1.5 * learningBoost;
            score += development * 1.2;
            score += (whiteMaterial > blackMaterial ? 50 : -50) * learningBoost;
            break;
          case 'D':
            score += centerControl * (0.8 + Math.random() * 0.4);
            score += development * (0.8 + Math.random() * 0.4);
            break;
          case 'E':
            score += centerControl * 1.2 * learningBoost;
            score += development * 1.2 * learningBoost;
            score += learning.gamesWonVsHuman * 5;
            break;
          default:
            score += centerControl + development;
        }

        return score - depth * 0.1;
      }, [boardToString]);

      const minimax = useCallback((board, depth, alpha, beta, maximizing, version, learning) => {
        if (depth === 0) return evaluatePosition(board, version, depth, learning);

        const player = maximizing ? 'white' : 'black';
        const moves = getAllMoves(board, player);
        if (moves.length === 0) return maximizing ? -Infinity : Infinity;

        if (maximizing) {
          let maxEval = -Infinity;
          for (const move of moves) {
            const newBoard = applyMove(board, move.from, move.to);
            const evalScore = minimax(newBoard, depth - 1, alpha, beta, false, version, learning);
            maxEval = Math.max(maxEval, evalScore);
            alpha = Math.max(alpha, evalScore);
            if (beta <= alpha) break;
          }
          return maxEval;
        } else {
          let minEval = Infinity;
          for (const move of moves) {
            const newBoard = applyMove(board, move.from, move.to);
            const evalScore = minimax(newBoard, depth - 1, alpha, beta, true, version, learning);
            minEval = Math.min(minEval, evalScore);
            beta = Math.min(beta, evalScore);
            if (beta <= alpha) break;
          }
          return minEval;
        }
      }, [evaluatePosition, getAllMoves, applyMove]);

      const selectBestMove = useCallback((board, player, learning, avoidMoves = []) => {
        const versions = ['A', 'B', 'C', 'D', 'E'];
        const versionMoves = {};

        let moves = getAllMoves(board, player);
        if (moves.length === 0) return null;

        if (avoidMoves.length > 0) {
          const filtered = moves.filter(m => {
            const key = `${m.from[0]},${m.from[1]}-${m.to[0]},${m.to[1]}`;
            return !avoidMoves.includes(key);
          });
          if (filtered.length > 0) moves = filtered;
        }

        const isMaximizing = player === 'white';
        const baseDepth = 2;
        const learningDepthBonus = Math.min(2, Math.floor(learning.gamesPlayed / 3));
        const searchDepth = baseDepth + learningDepthBonus;

        setAiThinking(`Analyzing depth ${searchDepth}... (${learning.gamesPlayed} games)`);

        versions.forEach(version => {
          let bestMove = null;
          let bestScore = isMaximizing ? -Infinity : Infinity;

          const shuffled = [...moves].sort(() => Math.random() - 0.5);

          shuffled.forEach(move => {
            const newBoard = applyMove(board, move.from, move.to);
            let score = minimax(newBoard, searchDepth - 1, -Infinity, Infinity, !isMaximizing, version, learning);

            const moveKey = `${move.piece}:${move.from[0]},${move.from[1]}-${move.to[0]},${move.to[1]}`;
            const winningBonus = learning.winningSequences.filter(s => s.includes(moveKey)).length * 20;
            const losingPenalty = learning.losingSequences.filter(s => s.includes(moveKey)).length * 15;
            score += (winningBonus - losingPenalty) * learning.learningRate;

            const posKey = boardToString(newBoard);
            if (learning.humanWeaknesses[posKey]) {
              score += learning.humanWeaknesses[posKey] * 30;
            }

            score += (Math.random() * 3);

            if (isMaximizing ? score > bestScore : score < bestScore) {
              bestScore = score;
              bestMove = move;
            }
          });

          versionMoves[version] = bestMove;
        });

        const moveVotes = {};
        Object.entries(versionMoves).forEach(([version, move]) => {
          if (!move) return;
          const key = `${move.from[0]},${move.from[1]}-${move.to[0]},${move.to[1]}`;

          if (!moveVotes[key]) {
            moveVotes[key] = { move, votes: 0, versions: [] };
          }

          const perf = learning.versionPerformance[version];
          let weight = 1 + (perf.score / 100);

          moveVotes[key].votes += weight;
          moveVotes[key].versions.push(version);
        });

        let bestMove = null, bestVotes = -Infinity;

        Object.values(moveVotes).forEach(({ move, votes }) => {
          if (votes > bestVotes) {
            bestVotes = votes;
            bestMove = move;
          }
        });

        setAiThinking('');
        return bestMove || moves[Math.floor(Math.random() * moves.length)];
      }, [getAllMoves, applyMove, minimax, boardToString]);

      const makeAIMove = useCallback(() => {
        if (gameStatus !== 'active') return;

        setTimeout(() => {
          const move = selectBestMove(board, currentPlayer, learningData);

          if (!move) {
            setGameStatus('draw');
            setLearningData(prev => ({
              ...prev,
              gamesPlayed: prev.gamesPlayed + 1
            }));
            return;
          }

          const newBoard = applyMove(board, move.from, move.to);
          const capturedPiece = board[move.to[0]][move.to[1]];

          setBoard(newBoard);
          setMoveLog(prev => [...prev, {
            player: currentPlayer,
            piece: move.piece,
            from: move.from,
            to: move.to,
            captured: capturedPiece
          }]);

          if (capturedPiece?.toLowerCase() === 'k') {
            const winner = currentPlayer;
            setGameStatus(`${winner}-wins`);
            setLearningData(prev => ({
              ...prev,
              gamesPlayed: prev.gamesPlayed + 1,
              gamesWonVsHuman: winner === 'black' ? prev.gamesWonVsHuman + 1 : prev.gamesWonVsHuman,
              gamesLostVsHuman: winner === 'white' ? prev.gamesLostVsHuman + 1 : prev.gamesLostVsHuman
            }));
            return;
          }

          if (moveLog.length >= 100) {
            setGameStatus('draw');
            setLearningData(prev => ({
              ...prev,
              gamesPlayed: prev.gamesPlayed + 1
            }));
            return;
          }

          setCurrentPlayer(currentPlayer === 'white' ? 'black' : 'white');
        }, 150);
      }, [board, currentPlayer, gameStatus, selectBestMove, applyMove, moveLog.length, learningData]);

      useEffect(() => {
        if (gameMode === 'self-play' && isPlaying && gameStatus === 'active') {
          selfPlayRef.current = setTimeout(makeAIMove, selfPlaySpeed);
        }
        return () => { if (selfPlayRef.current) clearTimeout(selfPlayRef.current); };
      }, [gameMode, isPlaying, gameStatus, currentPlayer, makeAIMove, selfPlaySpeed]);

      const handleSquareClick = useCallback((row, col) => {
        if (gameStatus !== 'active') return;
        if (gameMode === 'self-play') return;
        if ((gameMode === 'play-ai') && currentPlayer !== 'white') return;

        const piece = board[row][col];

        if (selectedSquare) {
          const [selRow, selCol] = selectedSquare;
          const isValid = validMoves.some(([r, c]) => r === row && c === col);

          if (isValid) {
            const selPiece = board[selRow][selCol];
            const newBoard = applyMove(board, [selRow, selCol], [row, col]);
            const captured = board[row][col];

            setBoard(newBoard);
            setMoveLog(prev => [...prev, {
              player: 'white',
              piece: selPiece,
              from: [selRow, selCol],
              to: [row, col],
              captured
            }]);

            if (captured?.toLowerCase() === 'k') {
              setGameStatus('white-wins');
              setLearningData(prev => ({
                ...prev,
                gamesPlayed: prev.gamesPlayed + 1,
                gamesLostVsHuman: prev.gamesLostVsHuman + 1
              }));
            } else {
              setCurrentPlayer('black');
              setTimeout(makeAIMove, 400);
            }
          }

          setSelectedSquare(null);
          setValidMoves([]);
        } else if (piece && isPlayerPiece(piece, 'white')) {
          setSelectedSquare([row, col]);
          setValidMoves(getValidMoves(board, row, col, piece));
        }
      }, [gameMode, gameStatus, currentPlayer, board, selectedSquare, validMoves, applyMove, isPlayerPiece, getValidMoves, makeAIMove, learningData]);

      const resetGame = useCallback(() => {
        setBoard(INITIAL_BOARD.map(row => [...row]));
        setCurrentPlayer('white');
        setSelectedSquare(null);
        setValidMoves([]);
        setGameStatus('active');
        setMoveLog([]);
        setPositionHistory([]);
        setLastFourMoves([]);
        setStuckCounter(0);
        setCurrentGameMoves([]);
        setGameCount(prev => prev + 1);
      }, []);

      useEffect(() => {
        if (gameMode === 'self-play' && isPlaying && gameStatus !== 'active') {
          setTimeout(resetGame, 1500);
        }
      }, [gameMode, isPlaying, gameStatus, resetGame]);

      const checkUnlock = useCallback(() => {
        if (unlockInput.trim().toUpperCase() === UNLOCK_CODE) {
          setLearningData(prev => ({
            ...prev,
            unlockedFeatures: true,
            unlockedCode: unlockInput
          }));
          setShowUnlockModal(false);
          setUnlockInput("");
        } else {
          alert("Incorrect unlock code. Please try again or purchase on Gumroad.");
        }
      }, [unlockInput]);

      const isFeatureLocked = useCallback((featureName) => {
        if (learningData.unlockedFeatures) return false;
        return ['27-lessons', 'puzzles', 'openings', 'videos'].includes(featureName);
      }, [learningData.unlockedFeatures]);

      const renderLockedFeature = (featureName, defaultContent) => {
        if (!isFeatureLocked(featureName)) return defaultContent;
        return (
          <div style={{
            textAlign: 'center',
            padding: 40,
            background: 'rgba(0,0,0,0.5)',
            borderRadius: 10,
            border: '2px dashed rgba(255,215,0,0.3)'
          }}>
            <div style={{ fontSize: 48, marginBottom: 15 }}>üîí</div>
            <div style={{ fontSize: 16, fontWeight: 'bold', color: '#ffd700', marginBottom: 10 }}>
              {featureName.toUpperCase()} - PREMIUM FEATURE
            </div>
            <div style={{ fontSize: 13, color: '#888', marginBottom: 20 }}>
              This feature is locked. Get full access for $9.99
            </div>
            <button onClick={() => window.open(GUMROAD_LINK, '_blank')} style={{
              padding: '12px 24px',
              background: 'linear-gradient(135deg, #ffd700, #ff8c00)',
              border: 'none',
              borderRadius: 6,
              color: '#1a1a2e',
              fontWeight: 'bold',
              fontSize: 14,
              cursor: 'pointer',
              marginBottom: 10
            }}>
              üõí BUY NOW - $9.99
            </button>
            <div style={{ fontSize: 12, color: '#666' }}>
              Or enter unlock code if you purchased
            </div>
            <input 
              type="text"
              placeholder="Enter unlock code"
              value={unlockInput}
              onChange={(e) => setUnlockInput(e.target.value)}
              style={{
                marginTop: 10,
                padding: '8px 12px',
                borderRadius: 4,
                border: '1px solid #444',
                background: '#222',
                color: '#fff',
                width: '100%'
              }}
              onKeyPress={(e) => e.key === 'Enter' && checkUnlock()}
            />
            <button onClick={checkUnlock} style={{
              marginTop: 8,
              padding: '8px 16px',
              background: '#3b82f6',
              border: 'none',
              borderRadius: 4,
              color: '#fff',
              cursor: 'pointer',
              fontSize: 12
            }}>
              Unlock
            </button>
          </div>
        );
      };

      // MENU
      if (gameMode === 'menu') {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%)',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: 20,
            fontFamily: "'Segoe UI', system-ui, sans-serif",
            color: '#fff'
          }}>
            <div style={{
              fontSize: 42,
              fontWeight: 'bold',
              marginBottom: 8,
              background: 'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent'
            }}>
              ‚ôî V2 Chess Academy ‚ôö
            </div>

            <div style={{
              fontSize: 13,
              color: '#888',
              marginBottom: 30,
              textAlign: 'center',
              maxWidth: 450
            }}>
              Complete Learning Platform
              <br />
              <span style={{ color: '#666', fontSize: 11 }}>
                5-Version AI ‚Ä¢ 27 Lessons ‚Ä¢ 15 Openings ‚Ä¢ Puzzles ‚Ä¢ Videos
              </span>
            </div>

            {learningData.gamesPlayed > 0 && (
              <div style={{
                background: 'rgba(255,215,0,0.1)',
                border: '1px solid rgba(255,215,0,0.3)',
                borderRadius: 8,
                padding: '10px 20px',
                marginBottom: 25,
                textAlign: 'center'
              }}>
                <div style={{ color: '#ffd700', fontSize: 12, fontWeight: 'bold' }}>AI Learning Stats</div>
                <div style={{ color: '#888', fontSize: 11, marginTop: 4 }}>
                  {learningData.gamesPlayed} games ‚Ä¢ Difficulty: {learningData.difficultyLevel.toFixed(1)} ‚Ä¢ 
                  AI: {learningData.gamesWonVsHuman}W - {learningData.gamesLostVsHuman}L
                </div>
              </div>
            )}

            <div style={{ display: 'flex', flexDirection: 'column', gap: 12, width: '100%', maxWidth: 350 }}>
              <button onClick={() => setGameMode('play-ai')} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(245,87,108,0.4)',
                transition: 'transform 0.2s'
              }}>
                ‚öîÔ∏è vs AI
              </button>

              <button onClick={() => setGameMode('2-player')} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(102,126,234,0.4)',
                transition: 'transform 0.2s'
              }}>
                üë• 2 Player
              </button>

              <button onClick={() => setGameMode('lessons')} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: isFeatureLocked('27-lessons') 
                  ? 'linear-gradient(135deg, #666, #444)' 
                  : 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(34,197,94,0.4)',
                transition: 'transform 0.2s',
                position: 'relative'
              }}>
                üìö 27 Lessons
                {isFeatureLocked('27-lessons') && <span style={{ marginLeft: 8 }}>üîí</span>}
              </button>

              <button onClick={() => setGameMode('puzzles')} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: isFeatureLocked('puzzles')
                  ? 'linear-gradient(135deg, #666, #444)'
                  : 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(245,158,11,0.4)',
                transition: 'transform 0.2s'
              }}>
                üß© Puzzles
                {isFeatureLocked('puzzles') && <span style={{ marginLeft: 8 }}>üîí</span>}
              </button>

              <button onClick={() => setGameMode('openings')} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: isFeatureLocked('openings')
                  ? 'linear-gradient(135deg, #666, #444)'
                  : 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(59,130,246,0.4)',
                transition: 'transform 0.2s'
              }}>
                üìñ Openings
                {isFeatureLocked('openings') && <span style={{ marginLeft: 8 }}>üîí</span>}
              </button>

              <button onClick={() => setGameMode('videos')} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: isFeatureLocked('videos')
                  ? 'linear-gradient(135deg, #666, #444)'
                  : 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(236,72,153,0.4)',
                transition: 'transform 0.2s'
              }}>
                üé¨ Videos
                {isFeatureLocked('videos') && <span style={{ marginLeft: 8 }}>üîí</span>}
              </button>

              <button onClick={() => setGameMode('self-play')} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: 'linear-gradient(135deg, #a855f7 0%, #9333ea 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(168,85,247,0.4)',
                transition: 'transform 0.2s'
              }}>
                ü§ñ Self-Play
              </button>

              <button onClick={() => window.open("https://lichess.org", "_blank")} style={{
                padding: '16px 24px',
                fontSize: 15,
                fontWeight: 'bold',
                background: 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)',
                border: 'none',
                borderRadius: 10,
                color: '#fff',
                cursor: 'pointer',
                boxShadow: '0 8px 25px rgba(6,182,212,0.4)',
                transition: 'transform 0.2s'
              }}>
                üåê Play Online (Lichess)
              </button>
            </div>

            <div style={{
              marginTop: 40,
              padding: 15,
              background: 'rgba(255,255,255,0.03)',
              borderRadius: 10,
              maxWidth: 450,
              textAlign: 'center'
            }}>
              <div style={{ fontSize: 12, fontWeight: 'bold', color: '#ffd700', marginBottom: 8 }}>
                ‚≠ê PREMIUM FEATURES
              </div>
              <div style={{ fontSize: 11, color: '#888', lineHeight: 1.6 }}>
                üîì Unlock all 27 lessons, puzzles, openings & videos for just <strong>$9.99</strong>
                <br />
                <button onClick={() => window.open(GUMROAD_LINK, '_blank')} style={{
                  marginTop: 10,
                  padding: '8px 16px',
                  background: 'linear-gradient(135deg, #ffd700, #ff8c00)',
                  border: 'none',
                  borderRadius: 6,
                  color: '#1a1a2e',
                  fontWeight: 'bold',
                  cursor: 'pointer'
                }}>
                  üõí Buy on Gumroad
                </button>
              </div>
            </div>
          </div>
        );
      }

      // LESSONS MODE
      if (gameMode === 'lessons') {
        return renderLockedFeature('27-lessons', (
          <div style={{ minHeight: '100vh', background: 'linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%)', padding: 20, color: '#fff' }}>
            <button onClick={() => setGameMode('menu')} style={{
              padding: '8px 16px',
              background: '#3b82f6',
              border: 'none',
              borderRadius: 6,
              color: '#fff',
              cursor: 'pointer',
              marginBottom: 20
            }}>
              ‚Üê Menu
            </button>

            <div style={{ maxWidth: 900, margin: '0 auto' }}>
              <h1 style={{ marginBottom: 30, color: '#4ade80' }}>27 Chess Lessons - Nested Thirds</h1>

              {!currentLesson ? (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: 15 }}>
                  {LESSONS.map((lesson) => (
                    <div
                      key={lesson.id}
                      onClick={() => setCurrentLesson(lesson)}
                      style={{
                        padding: 15,
                        background: 'rgba(255,255,255,0.05)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: 8,
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                    >
                      <div style={{ color: '#ffd700', fontWeight: 'bold', marginBottom: 5 }}>
                        Lesson {lesson.id}
                      </div>
                      <div style={{ fontSize: 14, fontWeight: 'bold' }}>{lesson.title}</div>
                      <div style={{ fontSize: 11, color: '#888', marginTop: 5 }}>
                        Part {lesson.part}, Section {lesson.section}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div style={{
                  background: 'rgba(255,255,255,0.03)',
                  border: '1px solid rgba(255,255,255,0.1)',
                  borderRadius: 10,
                  padding: 30
                }}>
                  <button onClick={() => setCurrentLesson(null)} style={{
                    marginBottom: 20,
                    padding: '8px 16px',
                    background: '#666',
                    border: 'none',
                    borderRadius: 6,
                    color: '#fff',
                    cursor: 'pointer'
                  }}>
                    ‚Üê Back
                  </button>

                  <div style={{ color: '#ffd700', marginBottom: 10 }}>
                    Lesson {currentLesson.id} ‚Ä¢ Part {currentLesson.part} ‚Ä¢ Section {currentLesson.section}
                  </div>
                  <h2 style={{ marginBottom: 20 }}>{currentLesson.title}</h2>
                  <div style={{ fontSize: 16, lineHeight: 1.8, color: '#ddd', marginBottom: 30 }}>
                    {currentLesson.content}
                  </div>
                  <div style={{ fontSize: 14, color: '#888' }}>
                    üìñ Complete this lesson and move to the next one!
                  </div>
                </div>
              )}
            </div>
          </div>
        ));
      }

      // PUZZLES MODE
      if (gameMode === 'puzzles') {
        return renderLockedFeature('puzzles', (
          <div style={{ minHeight: '100vh', background: 'linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%)', padding: 20, color: '#fff' }}>
            <button onClick={() => setGameMode('menu')} style={{
              padding: '8px 16px',
              background: '#3b82f6',
              border: 'none',
              borderRadius: 6,
              color: '#fff',
              cursor: 'pointer',
              marginBottom: 20
            }}>
              ‚Üê Menu
            </button>

            <div style={{ maxWidth: 800, margin: '0 auto' }}>
              <h1 style={{ marginBottom: 10, color: '#f59e0b' }}>Puzzle Trainer</h1>
              <div style={{ fontSize: 13, color: '#888', marginBottom: 20 }}>
                Your Rating: <strong style={{ color: '#ffd700' }}>{puzzleRating}</strong> ELO
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(160px, 1fr))', gap: 15 }}>
                {PUZZLES.map((puzzle) => (
                  <div
                    key={puzzle.id}
                    onClick={() => { setPuzzleMode('play'); setCurrentPuzzle(puzzle); }}
                    style={{
                      padding: 15,
                      background: 'rgba(245,158,11,0.1)',
                      border: '1px solid rgba(245,158,11,0.3)',
                      borderRadius: 8,
                      cursor: 'pointer'
                    }}
                  >
                    <div style={{ fontWeight: 'bold' }}>{puzzle.title}</div>
                    <div style={{ fontSize: 11, color: '#888', marginTop: 5 }}>
                      Difficulty: {puzzle.difficulty}/3
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        ));
      }

      // OPENINGS MODE
      if (gameMode === 'openings') {
        return renderLockedFeature('openings', (
          <div style={{ minHeight: '100vh', background: 'linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%)', padding: 20, color: '#fff' }}>
            <button onClick={() => setGameMode('menu')} style={{
              padding: '8px 16px',
              background: '#3b82f6',
              border: 'none',
              borderRadius: 6,
              color: '#fff',
              cursor: 'pointer',
              marginBottom: 20
            }}>
              ‚Üê Menu
            </button>

            <div style={{ maxWidth: 900, margin: '0 auto' }}>
              <h1 style={{ marginBottom: 30, color: '#3b82f6' }}>Opening Database</h1>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: 20 }}>
                {OPENINGS.map((opening, idx) => (
                  <div
                    key={idx}
                    style={{
                      padding: 20,
                      background: 'rgba(59,130,246,0.1)',
                      border: '1px solid rgba(59,130,246,0.3)',
                      borderRadius: 10
                    }}
                  >
                    <div style={{ fontSize: 16, fontWeight: 'bold', marginBottom: 10 }}>
                      {opening.name}
                    </div>
                    <div style={{ fontSize: 12, color: '#888', marginBottom: 10, fontFamily: 'monospace' }}>
                      {opening.moves}
                    </div>
                    <div style={{ fontSize: 13, color: '#aaa' }}>
                      üí° {opening.ideas}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        ));
      }

      // VIDEOS MODE
      if (gameMode === 'videos') {
        return renderLockedFeature('videos', (
          <div style={{ minHeight: '100vh', background: 'linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%)', padding: 20, color: '#fff' }}>
            <button onClick={() => setGameMode('menu')} style={{
              padding: '8px 16px',
              background: '#3b82f6',
              border: 'none',
              borderRadius: 6,
              color: '#fff',
              cursor: 'pointer',
              marginBottom: 20
            }}>
              ‚Üê Menu
            </button>

            <div style={{ maxWidth: 900, margin: '0 auto' }}>
              <h1 style={{ marginBottom: 30, color: '#ec4899' }}>Video Lessons</h1>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: 20 }}>
                {VIDEOS.map((video, idx) => (
                  <div
                    key={idx}
                    onClick={() => window.open(video.url, '_blank')}
                    style={{
                      padding: 20,
                      background: 'rgba(236,72,153,0.1)',
                      border: '1px solid rgba(236,72,153,0.3)',
                      borderRadius: 10,
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                  >
                    <div style={{ fontSize: 16, fontWeight: 'bold', marginBottom: 8 }}>
                      {video.title}
                    </div>
                    <div style={{ fontSize: 12, color: '#ec4899', marginBottom: 10 }}>
                      by {video.creator}
                    </div>
                    <div style={{ fontSize: 12, color: '#666' }}>
                      Click to open on YouTube ‚Üí
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        ));
      }

      // PLAY AI MODE
      if (gameMode === 'play-ai' || gameMode === '2-player') {
        const renderSquare = (row, col) => {
          const piece = board[row][col];
          const isLight = (row + col) % 2 === 0;
          const isSelected = selectedSquare?.[0] === row && selectedSquare?.[1] === col;
          const isValidTarget = validMoves.some(([r, c]) => r === row && c === col);

          let bg;
          if (isSelected) bg = 'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)';
          else if (isValidTarget) bg = 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)';
          else bg = isLight ? 'linear-gradient(135deg, #f0d9b5 0%, #e8d0a8 100%)' : 'linear-gradient(135deg, #b58863 0%, #986a45 100%)';

          return (
            <div
              key={`${row}-${col}`}
              onClick={() => handleSquareClick(row, col)}
              style={{
                width: 52,
                height: 52,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: 36,
                cursor: 'pointer',
                background: bg,
                boxShadow: isSelected ? 'inset 0 0 12px rgba(255,215,0,0.6)' : 'inset 0 0 2px rgba(0,0,0,0.1)',
                transition: 'all 0.15s ease',
                userSelect: 'none'
              }}
            >
              {piece && (
                <span style={{
                  color: piece === piece.toUpperCase() ? '#fff' : '#1a1a2e',
                  textShadow: piece === piece.toUpperCase() 
                    ? '1px 1px 3px rgba(0,0,0,0.8), 0 0 8px rgba(255,255,255,0.3)'
                    : '1px 1px 3px rgba(0,0,0,0.3)',
                  filter: 'drop-shadow(1px 1px 1px rgba(0,0,0,0.4))'
                }}>
                  {PIECE_SYMBOLS[piece]}
                </span>
              )}
              {isValidTarget && !piece && (
                <div style={{
                  width: 12,
                  height: 12,
                  borderRadius: '50%',
                  background: 'rgba(74,222,128,0.7)',
                  boxShadow: '0 0 8px rgba(74,222,128,0.6)'
                }} />
              )}
            </div>
          );
        };

        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%)',
            display: 'flex',
            fontFamily: "'Segoe UI', system-ui, sans-serif",
            color: '#fff',
            padding: 15
          }}>
            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 15, marginBottom: 15 }}>
                <button onClick={() => { setGameMode('menu'); resetGame(); }} style={{
                  padding: '6px 14px',
                  background: 'rgba(255,255,255,0.1)',
                  border: '1px solid rgba(255,255,255,0.2)',
                  borderRadius: 5,
                  color: '#fff',
                  cursor: 'pointer'
                }}>
                  ‚Üê Menu
                </button>
                <div style={{ fontSize: 16, fontWeight: 'bold', color: '#ffd700' }}>
                  {gameMode === '2-player' ? 'üë• Two Player' : '‚öîÔ∏è vs AI'}
                </div>
              </div>

              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(8, 52px)',
                border: '3px solid #2a2a4a',
                borderRadius: 4,
                boxShadow: '0 15px 50px rgba(0,0,0,0.5)'
              }}>
                {[...Array(8)].map((_, r) => [...Array(8)].map((_, c) => renderSquare(r, c)))}
              </div>

              <div style={{
                marginTop: 15,
                padding: '10px 20px',
                borderRadius: 8,
                fontWeight: 'bold',
                background: gameStatus !== 'active'
                  ? gameStatus === 'white-wins' ? 'linear-gradient(135deg, #4ade80, #22c55e)' 
                  : gameStatus === 'black-wins' ? 'linear-gradient(135deg, #ef4444, #dc2626)'
                  : 'linear-gradient(135deg, #f59e0b, #d97706)'
                  : currentPlayer === 'white' ? 'linear-gradient(135deg, #f0f0f0, #d0d0d0)' : 'linear-gradient(135deg, #374151, #1f2937)',
                color: (gameStatus !== 'active' || currentPlayer === 'white') ? '#1a1a2e' : '#fff'
              }}>
                {gameStatus === 'white-wins' ? 'üéâ White Wins!' : 
                 gameStatus === 'black-wins' ? 'ü§ñ Black Wins!' :
                 gameStatus === 'draw' ? 'ü§ù Draw!' :
                 `${currentPlayer === 'white' ? 'White' : 'Black'} to move`}
              </div>

              <div style={{ marginTop: 15, display: 'flex', gap: 8 }}>
                <button onClick={resetGame} style={{
                  padding: '8px 16px',
                  background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                  border: 'none',
                  borderRadius: 6,
                  color: '#fff',
                  cursor: 'pointer',
                  fontWeight: 'bold'
                }}>
                  üîÑ New Game
                </button>
              </div>
            </div>

            <div style={{
              width: 260,
              marginLeft: 20,
              background: 'rgba(255,255,255,0.03)',
              borderRadius: 10,
              padding: 15,
              border: '1px solid rgba(255,255,255,0.08)',
              maxHeight: '80vh',
              overflowY: 'auto'
            }}>
              <div style={{ fontSize: 13, fontWeight: 'bold', color: '#ffd700', marginBottom: 10 }}>
                üìä Stats
              </div>
              <div style={{ fontSize: 11, marginBottom: 15 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                  <span style={{ color: '#888' }}>Games:</span>
                  <span style={{ color: '#22c55e', fontWeight: 'bold' }}>{learningData.gamesPlayed}</span>
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                  <span style={{ color: '#888' }}>Difficulty:</span>
                  <span style={{ color: '#f59e0b', fontWeight: 'bold' }}>{learningData.difficultyLevel.toFixed(1)}/10</span>
                </div>
              </div>

              <div style={{ fontSize: 12, fontWeight: 'bold', color: '#fff', marginBottom: 8 }}>
                Version Stats
              </div>
              {Object.entries(learningData.versionPerformance).map(([v, data]) => (
                <div key={v} style={{
                  background: 'rgba(255,255,255,0.03)',
                  border: '1px solid rgba(255,255,255,0.1)',
                  borderRadius: 4,
                  padding: '5px 8px',
                  marginBottom: 4,
                  fontSize: 10
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ fontWeight: 'bold' }}>V{v}</span>
                    <span style={{ color: '#888' }}>{data.score}pts</span>
                  </div>
                  <div style={{ color: '#666', fontSize: 9 }}>W:{data.wins} L:{data.losses}</div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      // SELF-PLAY MODE
      if (gameMode === 'self-play') {
        const renderSquare = (row, col) => {
          const piece = board[row][col];
          const isLight = (row + col) % 2 === 0;
          let bg = isLight ? 'linear-gradient(135deg, #f0d9b5 0%, #e8d0a8 100%)' : 'linear-gradient(135deg, #b58863 0%, #986a45 100%)';

          return (
            <div
              key={`${row}-${col}`}
              style={{
                width: 52,
                height: 52,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: 36,
                background: bg,
                userSelect: 'none'
              }}
            >
              {piece && <span>{PIECE_SYMBOLS[piece]}</span>}
            </div>
          );
        };

        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(180deg, #0a0a12 0%, #1a1a2e 50%, #0f1929 100%)',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            padding: 20,
            color: '#fff'
          }}>
            <div style={{ marginBottom: 20 }}>
              <button onClick={() => { setGameMode('menu'); setIsPlaying(false); resetGame(); }} style={{
                padding: '8px 16px',
                background: '#3b82f6',
                border: 'none',
                borderRadius: 6,
                color: '#fff',
                cursor: 'pointer'
              }}>
                ‚Üê Menu
              </button>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(8, 52px)', border: '3px solid #2a2a4a', borderRadius: 4 }}>
              {[...Array(8)].map((_, r) => [...Array(8)].map((_, c) => renderSquare(r, c)))}
            </div>

            <div style={{ marginTop: 20, display: 'flex', gap: 8, alignItems: 'center' }}>
              <button onClick={() => setIsPlaying(!isPlaying)} style={{
                padding: '8px 16px',
                border: 'none',
                borderRadius: 6,
                color: '#fff',
                cursor: 'pointer',
                fontWeight: 'bold',
                background: isPlaying ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 'linear-gradient(135deg, #22c55e, #16a34a)'
              }}>
                {isPlaying ? '‚è∏ Pause' : '‚ñ∂ Play'}
              </button>
              <select value={selfPlaySpeed} onChange={(e) => setSelfPlaySpeed(Number(e.target.value))} style={{
                padding: '8px 12px',
                background: '#2a2a4a',
                border: '1px solid #3a3a5a',
                borderRadius: 6,
                color: '#fff',
                cursor: 'pointer'
              }}>
                <option value={800}>Slow</option>
                <option value={400}>Normal</option>
                <option value={150}>Fast</option>
                <option value={50}>Ultra</option>
              </select>
            </div>

            <div style={{ marginTop: 20, fontSize: 13, color: '#888' }}>
              Game {gameCount + 1} | Moves: {moveLog.length}
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<ChessV2Academy />, document.getElementById('root'));
  </script>
</body>
</html>
